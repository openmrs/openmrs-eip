<!--
    Route to process exceptions and log them in the receiver_retry_queue table in the management DB.
 -->
<routes xmlns="http://camel.apache.org/schema/spring">
    <route id="inbound-error-handler" errorHandlerRef="shutdownErrorHandler">
        <from uri="direct:inbound-error-handler" />

        <choice>
            <when>
                <method beanType="org.openmrs.eip.app.AppUtils" method="isAppContextStopping()" />
                <log message="Ignoring the error because the application context is stopping" />
            </when>
            <otherwise>
                <when>
                    <simple>${exchangeProperty.retry-item-id} != null</simple>
                    <log message="Entities with failed retries in current retry run: ${exchangeProperty.failed-entities.size()}" loggingLevel="DEBUG" />

                    <setBody>
                        <method beanType="org.openmrs.eip.component.utils.Utils" method="getListOfModelClassHierarchy(${exchangeProperty.retry-item.modelClassName})" />
                    </setBody>
                    <split parallelProcessing="false" stopOnException="true">
                        <simple>${body}</simple>
                        <script>
                            <simple>${exchangeProperty.failed-entities.add(${body}#${exchangeProperty.retry-item.identifier})}</simple>
                        </script>
                    </split>
                </when>

                <setProperty name="exceptionType">
                    <simple>${exception.class.name}</simple>
                </setProperty>
                <setProperty name="error-msg">
                    <simple>${exception.message}</simple>
                </setProperty>

                <log message="Error: ${exchangeProperty.error-msg}" loggingLevel="WARN" />

                <setProperty name="rootCause">
                    <method beanType="org.apache.commons.lang3.exception.ExceptionUtils" method="getRootCause(${exception})" />
                </setProperty>

                <when>
                    <simple>${exception.cause} != null &amp;&amp; ${exchangeProperty.rootCause} != null</simple>
                    <setProperty name="exceptionType">
                        <simple>${exchangeProperty.rootCause.class.name}</simple>
                    </setProperty>

                    <when>
                        <simple>${exchangeProperty.rootCause.message} != null</simple>
                        <setProperty name="error-msg">
                            <simple>${exchangeProperty.rootCause.message}</simple>
                        </setProperty>

                        <log message="Cause: ${exchangeProperty.rootCause.message}" loggingLevel="WARN" />
                    </when>
                </when>

                <when>
                    <simple>${exchangeProperty.error-msg.length()} > 1024</simple>
                    <setProperty name="error-msg">
                        <simple>${exchangeProperty.error-msg.substring(0, 1024)}</simple>
                    </setProperty>
                </when>

                <choice>
                    <when>
                        <!-- This is a failure when processing a new message -->
                        <simple>${exchangeProperty.retry-item-id} == null</simple>
                        <log message="Adding new item to retry queue" />
                        <setBody>
                            <spel>
                                #{new org.openmrs.eip.app.management.entity.ReceiverRetryQueueItem()}
                            </spel>
                        </setBody>
                        <script>
                            <spel>
                                #{body.setIdentifier(getProperty('entity-id'))}
                                #{body.setModelClassName(getProperty('model-class'))}
                                #{body.setEntityPayload(getProperty('entity-payload', T(java.lang.String)))}
                                #{body.setExceptionType(getProperty('exceptionType'))}
                                #{body.setMessage(getProperty('error-msg'))}
                                #{body.setDateCreated(new java.util.Date())}
                                #{body.setSite(getProperty('sync-message').getSite())}
                                #{body.setDateSentBySender(getProperty('sync-message').getDateSentBySender())}
                                #{body.setSnapshot(getProperty('sync-message').getSnapshot())}
                                #{body.setMessageUuid(getProperty('sync-message').getMessageUuid())}
                                #{body.setDateReceived(getProperty('sync-message').getDateCreated())}
                            </spel>
                        </script>

                        <log message="Saving retry item" loggingLevel="DEBUG" />

                        <to uri="jpa:ReceiverRetryQueueItem?usePersist=true" />

                        <log message="Successfully saved retry item" loggingLevel="DEBUG" />

                        <setProperty name="org.openmrs.eip.app.receiver.sync-movedToErrorQueue">
                            <simple>true</simple>
                        </setProperty>
                    </when>
                    <otherwise>
                        <!-- This is a failure when re-processing a previously failed message -->
                        <setBody>
                            <exchangeProperty>retry-item</exchangeProperty>
                        </setBody>
                        <when>
                            <simple>${body} == null</simple>
                            <log message="Loading retry item with id: ${exchangeProperty.retry-item-id}" loggingLevel="DEBUG" />

                            <toD uri="jpa:ReceiverRetryQueueItem?query=SELECT i FROM ReceiverRetryQueueItem i WHERE i.id = ${exchangeProperty.retry-item-id}" />

                            <log message="Loaded: ${body}" loggingLevel="DEBUG" />
                            <setBody>
                                <simple>${body[0]}</simple>
                            </setBody>
                        </when>

                        <script>
                            <spel>
                                #{body.setExceptionType(getProperty('exceptionType'))}
                                #{body.setMessage(getProperty('error-msg'))}
                                #{body.setDateChanged(new java.util.Date())}
                            </spel>
                        </script>

                        <log message="Saving updates for retry item" loggingLevel="DEBUG" />

                        <to uri="jpa:ReceiverRetryQueueItem" />

                        <log message="Successfully updated retry item" loggingLevel="DEBUG" />
                    </otherwise>
                </choice>
            </otherwise>
        </choice>
        
    </route>
</routes>
