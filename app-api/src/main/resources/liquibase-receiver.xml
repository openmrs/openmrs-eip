<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog context="receiver"
                   xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
	    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <changeSet author="wluyima" id="20210202-1100">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="receiver_retry_queue"/>
            </not>
        </preConditions>
        <comment>Adding receiver_retry_queue table</comment>
        
        <createTable tableName="receiver_retry_queue">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="model_class_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="entity_payload" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="attempt_count" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="cause_message" type="VARCHAR(1024)"/>
            <column name="message" type="VARCHAR(1024)"/>
            <column name="date_created" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="date_changed" type="DATETIME"/>
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20210202-1101">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="receiver_conflict_queue"/>
            </not>
        </preConditions>
        <comment>Adding receiver_conflict_queue table</comment>

        <createTable tableName="receiver_conflict_queue">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="date_created" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="entity_payload" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="model_class_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="is_resolved" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20210202-1050">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="site_info"/>
            </not>
        </preConditions>
        <comment>Adding site_info table</comment>

        <createTable tableName="site_info">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="DATETIME">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

 	<changeSet author="jpboane" id="20211014-1411">
        <preConditions onFail="MARK_RAN">
        	<not>
                <columnExists columnName="site_district" tableName="site_info"/>
            </not>
        </preConditions>
        <comment>Add site_district column to site_info table</comment>

        <addColumn tableName="site_info">
            <column name="site_district" type="VARCHAR(255)"/>
        </addColumn>
    </changeSet>
    
    <changeSet author="jpboane" id="20211014-1725">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="site_district" tableName="site_info" />
        </preConditions>
        <comment>Update site_district field on site_info table</comment>

        <update tableName="site_info">
            <column name="site_district"  value="AKNOWN"/>
            <where>site_district IS NULL</where>
        </update>
    </changeSet>
    
    <changeSet author="jpboane" id="20211014-1733">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="site_district" tableName="site_info" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM site_info WHERE site_district IS NULL
            </sqlCheck>
        </preConditions>
        <comment>Adding not null constraint to site_info.site_district</comment>

        <addNotNullConstraint tableName="site_info" columnName="site_district" columnDataType="VARCHAR(255)"/>
    </changeSet>
    
    <changeSet author="jpboane" id="20211014-1814">
        <preConditions onFail="MARK_RAN">
        	<not>
                <columnExists columnName="site_instance_name" tableName="site_info"/>
            </not>
        </preConditions>
        <comment>Add site_instance_name column to site_info table</comment>

        <addColumn tableName="site_info">
            <column name="site_instance_name" type="VARCHAR(255)"/>
        </addColumn>
    </changeSet>
    
    <changeSet author="jpboane" id="20211014-1816">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="site_instance_name" tableName="site_info" />
        </preConditions>
        <comment>Update site_instance_name field on site_info table</comment>

        <update tableName="site_info">
            <column name="site_instance_name"  valueComputed="name"/>
            <where>site_instance_name IS NULL</where>
        </update>
    </changeSet>
    
    <changeSet author="jpboane" id="20211014-1817">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="site_instance_name" tableName="site_info" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM site_info WHERE site_instance_name IS NULL
            </sqlCheck>
        </preConditions>
        <comment>Adding not null constraint to site_info.site_instance_name</comment>

        <addNotNullConstraint tableName="site_info" columnName="site_instance_name" columnDataType="VARCHAR(255)"/>
    </changeSet>

    <changeSet author="wluyima" id="20210202-1055">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="receiver_sync_status"/>
            </not>
        </preConditions>
        <comment>Adding receiver_sync_status table</comment>

        <createTable tableName="receiver_sync_status">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="site_info_id" type="BIGINT">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="last_sync_date" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="DATETIME">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="sync_status_site_fk"
                                 baseTableName="receiver_sync_status"
                                 baseColumnNames="site_info_id"
                                 referencedTableName="site_info"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet author="wluyima" id="20210614-2101">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists columnName="exception_type" tableName="receiver_retry_queue" />
            </not>
        </preConditions>
        <comment>Add exception_type column to receiver_retry_queue table</comment>

        <addColumn tableName="receiver_retry_queue">
            <column name="exception_type" type="VARCHAR(255)"/>
        </addColumn>
    </changeSet>

    <changeSet author="wluyima" id="20210614-2102">
        <preConditions onFail="MARK_RAN">
            <not>
                <sqlCheck expectedResult="0">
                    SELECT COUNT(*) FROM receiver_retry_queue
                </sqlCheck>
            </not>
        </preConditions>
        <comment>Setting receiver_retry_queue.exception_type for existing rows</comment>

        <update tableName="receiver_retry_queue">
            <column name="exception_type" value="org.openmrs.eip.component.exception.EIPException" />
        </update>
    </changeSet>

    <changeSet author="wluyima" id="20210614-2103">
        <validCheckSum>8:16f10e37d5d264987862487d8cdd4bde</validCheckSum>
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="receiver_retry_queue" columnName="exception_type" />
        </preConditions>
        <comment>Adding not null constraint to receiver_retry_queue.exception_type</comment>

        <addNotNullConstraint tableName="receiver_retry_queue" columnName="exception_type" columnDataType="VARCHAR(255)" />
    </changeSet>

    <changeSet author="wluyima" id="20210601-1410">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="message" tableName="receiver_retry_queue" />
            <columnExists columnName="cause_message" tableName="receiver_retry_queue" />
            <not>
                <sqlCheck expectedResult="0">
                    SELECT COUNT(*) FROM receiver_retry_queue WHERE cause_message IS NOT NULL
                </sqlCheck>
            </not>
        </preConditions>
        <comment>Copying values from receiver_retry_queue.cause_message to receiver_retry_queue.message column</comment>

        <update tableName="receiver_retry_queue">
            <column name="message" valueComputed="cause_message" />
            <where>cause_message IS NOT NULL</where>
        </update>
    </changeSet>
    
    <changeSet author="wluyima" id="20210601-1411">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="cause_message" tableName="receiver_retry_queue" />
        </preConditions>
        <comment>Drop receiver_retry_queue.cause_message column</comment>

        <dropColumn tableName="receiver_retry_queue" columnName="cause_message" />
    </changeSet>

    <changeSet author="wluyima" id="20210825-1712">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists indexName="site_info_identifier_uk" tableName="site_info" columnNames="identifier" />
            </not>
        </preConditions>
        <comment>Add unique constraint to site_info.identifier column</comment>

        <addUniqueConstraint constraintName="site_info_identifier_uk" tableName="site_info" columnNames="identifier" />
    </changeSet>

    <changeSet author="wluyima" id="20210825-1713">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists indexName="site_info_name_uk" tableName="site_info" columnNames="name" />
            </not>
        </preConditions>
        <comment>Add unique constraint to site_info.name column</comment>

        <addUniqueConstraint constraintName="site_info_name_uk" tableName="site_info" columnNames="name" />
    </changeSet>

    <changeSet author="wluyima" id="20210827-1302">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="receiver_sync_msg"/>
            </not>
        </preConditions>
        <comment>Adding receiver_sync_msg table</comment>

        <createTable tableName="receiver_sync_msg">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="model_class_name" type="VARCHAR(255)">
                <constraints nullable="false" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" />
            </column>
            <column name="entity_payload" type="TEXT">
                <constraints nullable="false" />
            </column>
            <column name="site_id" type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column name="date_created" type="TIMESTAMP">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="sync_msg_site_fk"
                                 baseTableName="receiver_sync_msg"
                                 baseColumnNames="site_id"
                                 referencedTableName="site_info"
                                 referencedColumnNames="id" />
    </changeSet>

    <changeSet author="wluyima" id="20211111-1400">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists columnName="site_id" tableName="receiver_retry_queue" />
            </not>
        </preConditions>
        <comment>Add site_id column to receiver_retry_queue table</comment>

        <addColumn tableName="receiver_retry_queue">
            <column name="site_id" type="BIGINT" />
        </addColumn>

        <addForeignKeyConstraint constraintName="receiver_retry_queue_site_fk"
                                 baseTableName="receiver_retry_queue"
                                 baseColumnNames="site_id"
                                 referencedTableName="site_info"
                                 referencedColumnNames="id" />
    </changeSet>

    <changeSet author="wluyima" id="20211111-1401">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists columnName="site_id" tableName="receiver_conflict_queue" />
            </not>
        </preConditions>
        <comment>Add site_id column to receiver_conflict_queue table</comment>

        <addColumn tableName="receiver_conflict_queue">
            <column name="site_id" type="BIGINT" />
        </addColumn>

        <addForeignKeyConstraint constraintName="receiver_conflict_queue_site_fk"
                                 baseTableName="receiver_conflict_queue"
                                 baseColumnNames="site_id"
                                 referencedTableName="site_info"
                                 referencedColumnNames="id" />
    </changeSet>

    <changeSet author="wluyima" id="20211208-1400">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="receiver_sync_request" />
            </not>
        </preConditions>
        <comment>Adding receiver_sync_request table</comment>

        <createTable tableName="receiver_sync_request">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="table_name" type="VARCHAR(100)">
                <constraints nullable="false" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" />
            </column>
            <column name="site_id" type="BIGINT" />
            <column name="status" type="VARCHAR(50)" defaultValue="NEW" />
            <column name="found" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false" />
            </column>
            <column name="request_uuid" type="VARCHAR(38)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="date_created" type="DATETIME">
                <constraints nullable="false" />
            </column>
            <column name="date_received" type="DATETIME" />
            <column name="date_sent" type="DATETIME" />
        </createTable>

        <addForeignKeyConstraint constraintName="receiver_sync_request_site_fk"
                                 baseTableName="receiver_sync_request"
                                 baseColumnNames="site_id"
                                 referencedTableName="site_info"
                                 referencedColumnNames="id" />
    </changeSet>

    <changeSet author="wluyima" id="20211007-1801">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="person_hash" />
            </not>
        </preConditions>
        <comment>Adding person_hash table</comment>

        <createTable tableName="person_hash">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="hash" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="TIMESTAMP(3)">
                <constraints nullable="false" />
            </column>
            <column name="date_changed" type="TIMESTAMP(3)" />
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20211007-1802">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="patient_hash" />
            </not>
        </preConditions>
        <comment>Adding patient_hash table</comment>

        <createTable tableName="patient_hash">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="hash" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="TIMESTAMP(3)">
                <constraints nullable="false" />
            </column>
            <column name="date_changed" type="TIMESTAMP(3)" />
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20211007-1803">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="visit_hash" />
            </not>
        </preConditions>
        <comment>Adding visit_hash table</comment>

        <createTable tableName="visit_hash">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="hash" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="TIMESTAMP(3)">
                <constraints nullable="false" />
            </column>
            <column name="date_changed" type="TIMESTAMP(3)" />
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20211007-1804">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="encounter_hash" />
            </not>
        </preConditions>
        <comment>Adding encounter_hash table</comment>

        <createTable tableName="encounter_hash">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="hash" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="TIMESTAMP(3)">
                <constraints nullable="false" />
            </column>
            <column name="date_changed" type="TIMESTAMP(3)" />
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20211007-1805">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="obs_hash" />
            </not>
        </preConditions>
        <comment>Adding obs_hash table</comment>

        <createTable tableName="obs_hash">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="hash" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="TIMESTAMP(3)">
                <constraints nullable="false" />
            </column>
            <column name="date_changed" type="TIMESTAMP(3)" />
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20211007-1806">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="person_attribute_hash" />
            </not>
        </preConditions>
        <comment>Adding person_attribute_hash table</comment>

        <createTable tableName="person_attribute_hash">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="hash" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="TIMESTAMP(3)">
                <constraints nullable="false" />
            </column>
            <column name="date_changed" type="TIMESTAMP(3)" />
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20211007-1807">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="patient_program_hash" />
            </not>
        </preConditions>
        <comment>Adding patient_program_hash table</comment>

        <createTable tableName="patient_program_hash">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="hash" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="TIMESTAMP(3)">
                <constraints nullable="false" />
            </column>
            <column name="date_changed" type="TIMESTAMP(3)" />
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20211007-1808">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="patient_state_hash" />
            </not>
        </preConditions>
        <comment>Adding patient_state_hash table</comment>

        <createTable tableName="patient_state_hash">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="hash" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="TIMESTAMP(3)">
                <constraints nullable="false" />
            </column>
            <column name="date_changed" type="TIMESTAMP(3)" />
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20211007-1809">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="visit_attribute_hash" />
            </not>
        </preConditions>
        <comment>Adding visit_attribute_hash table</comment>

        <createTable tableName="visit_attribute_hash">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="hash" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="TIMESTAMP(3)">
                <constraints nullable="false" />
            </column>
            <column name="date_changed" type="TIMESTAMP(3)" />
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20211007-1810">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="encounter_diagnosis_hash" />
            </not>
        </preConditions>
        <comment>Adding encounter_diagnosis_hash table</comment>

        <createTable tableName="encounter_diagnosis_hash">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="hash" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="TIMESTAMP(3)">
                <constraints nullable="false" />
            </column>
            <column name="date_changed" type="TIMESTAMP(3)" />
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20211007-1811">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="condition_hash" />
            </not>
        </preConditions>
        <comment>Adding condition_hash table</comment>

        <createTable tableName="condition_hash">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="hash" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="TIMESTAMP(3)">
                <constraints nullable="false" />
            </column>
            <column name="date_changed" type="TIMESTAMP(3)" />
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20211007-1812">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="person_name_hash" />
            </not>
        </preConditions>
        <comment>Adding person_name_hash table</comment>

        <createTable tableName="person_name_hash">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="hash" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="TIMESTAMP(3)">
                <constraints nullable="false" />
            </column>
            <column name="date_changed" type="TIMESTAMP(3)" />
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20211007-1813">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="allergy_hash" />
            </not>
        </preConditions>
        <comment>Adding allergy_hash table</comment>

        <createTable tableName="allergy_hash">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="hash" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="TIMESTAMP(3)">
                <constraints nullable="false" />
            </column>
            <column name="date_changed" type="TIMESTAMP(3)" />
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20211007-1814">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="person_address_hash" />
            </not>
        </preConditions>
        <comment>Adding person_address_hash table</comment>

        <createTable tableName="person_address_hash">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="hash" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="TIMESTAMP(3)">
                <constraints nullable="false" />
            </column>
            <column name="date_changed" type="TIMESTAMP(3)" />
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20211007-1815">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="patient_identifier_hash" />
            </not>
        </preConditions>
        <comment>Adding patient_identifier_hash table</comment>

        <createTable tableName="patient_identifier_hash">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="hash" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="TIMESTAMP(3)">
                <constraints nullable="false" />
            </column>
            <column name="date_changed" type="TIMESTAMP(3)" />
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20211007-1816">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="orders_hash" />
            </not>
        </preConditions>
        <comment>Adding orders_hash table</comment>

        <createTable tableName="orders_hash">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="hash" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="TIMESTAMP(3)">
                <constraints nullable="false" />
            </column>
            <column name="date_changed" type="TIMESTAMP(3)" />
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20211007-1817">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="drug_order_hash" />
            </not>
        </preConditions>
        <comment>Adding drug_order_hash table</comment>

        <createTable tableName="drug_order_hash">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="hash" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="TIMESTAMP(3)">
                <constraints nullable="false" />
            </column>
            <column name="date_changed" type="TIMESTAMP(3)" />
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20211007-1818">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="test_order_hash" />
            </not>
        </preConditions>
        <comment>Adding test_order_hash table</comment>

        <createTable tableName="test_order_hash">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="hash" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="TIMESTAMP(3)">
                <constraints nullable="false" />
            </column>
            <column name="date_changed" type="TIMESTAMP(3)" />
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20211007-1819">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="relationship_hash" />
            </not>
        </preConditions>
        <comment>Adding relationship_hash table</comment>

        <createTable tableName="relationship_hash">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="hash" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="TIMESTAMP(3)">
                <constraints nullable="false" />
            </column>
            <column name="date_changed" type="TIMESTAMP(3)" />
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20211007-1820">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="encounter_provider_hash" />
            </not>
        </preConditions>
        <comment>Adding encounter_provider_hash table</comment>

        <createTable tableName="encounter_provider_hash">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="hash" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="TIMESTAMP(3)">
                <constraints nullable="false" />
            </column>
            <column name="date_changed" type="TIMESTAMP(3)" />
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20211007-1821">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="order_group_hash" />
            </not>
        </preConditions>
        <comment>Adding order_group_hash table</comment>

        <createTable tableName="order_group_hash">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="hash" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="TIMESTAMP(3)">
                <constraints nullable="false" />
            </column>
            <column name="date_changed" type="TIMESTAMP(3)" />
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20211007-1822">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="patient_program_attribute_hash" />
            </not>
        </preConditions>
        <comment>Adding patient_program_attribute_hash table</comment>

        <createTable tableName="patient_program_attribute_hash">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="hash" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="TIMESTAMP(3)">
                <constraints nullable="false" />
            </column>
            <column name="date_changed" type="TIMESTAMP(3)" />
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20211007-1823">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="users_hash" />
            </not>
        </preConditions>
        <comment>Adding users_hash table</comment>

        <createTable tableName="users_hash">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="hash" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="TIMESTAMP(3)">
                <constraints nullable="false" />
            </column>
            <column name="date_changed" type="TIMESTAMP(3)" />
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20211007-1824">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="provider_hash" />
            </not>
        </preConditions>
        <comment>Adding provider_hash table</comment>

        <createTable tableName="provider_hash">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="hash" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="TIMESTAMP(3)">
                <constraints nullable="false" />
            </column>
            <column name="date_changed" type="TIMESTAMP(3)" />
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20220203-1420">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="gaac_hash" />
            </not>
        </preConditions>
        <comment>Adding gaac_hash table</comment>

        <createTable tableName="gaac_hash">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="hash" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="TIMESTAMP(3)">
                <constraints nullable="false" />
            </column>
            <column name="date_changed" type="TIMESTAMP(3)" />
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20220203-1421">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="gaac_member_hash" />
            </not>
        </preConditions>
        <comment>Adding gaac_member_hash table</comment>

        <createTable tableName="gaac_member_hash">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="hash" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="TIMESTAMP(3)">
                <constraints nullable="false" />
            </column>
            <column name="date_changed" type="TIMESTAMP(3)" />
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20220203-1422">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="gaac_family_hash" />
            </not>
        </preConditions>
        <comment>Adding gaac_family_hash table</comment>

        <createTable tableName="gaac_family_hash">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="hash" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="TIMESTAMP(3)">
                <constraints nullable="false" />
            </column>
            <column name="date_changed" type="TIMESTAMP(3)" />
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20220203-1423">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="gaac_family_member_hash" />
            </not>
        </preConditions>
        <comment>Adding gaac_family_member_hash table</comment>

        <createTable tableName="gaac_family_member_hash">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="hash" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="TIMESTAMP(3)">
                <constraints nullable="false" />
            </column>
            <column name="date_changed" type="TIMESTAMP(3)" />
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20220321-1200">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists columnName="is_snapshot" tableName="receiver_sync_msg" />
            </not>
        </preConditions>
        <comment>Add is_snapshot column to receiver_sync_msg table</comment>

        <addColumn tableName="receiver_sync_msg">
            <column name="is_snapshot" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet author="wluyima" id="20220518-1400">
        <comment>Changing date_created and date_changed column datatypes to datetime for all tables used to store hashes</comment>
        <customChange class="org.openmrs.eip.app.management.UpdateColumnDatatypeChangeSet" />
    </changeSet>
    
    <changeSet author="lccpinto" id="20220601-1140">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists columnName="message_uuid" tableName="receiver_sync_msg" />
            </not>
        </preConditions>
        <comment>Add message_uuid column to receiver_sync_msg table</comment>

        <addColumn tableName="receiver_sync_msg">
            <column name="message_uuid" type="VARCHAR(38)" />
        </addColumn>
    </changeSet>

    <changeSet author="wluyima" id="20220526-1500">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists columnName="sync_disabled" tableName="site_info" />
            </not>
        </preConditions>
        <comment>Add sync_disabled column to site_info table</comment>

        <addColumn tableName="site_info">
            <column name="sync_disabled" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet author="wluyima" id="20220707-1501">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="receiver_sync_msg" columnName="date_created" />
        </preConditions>
        <comment>Changing datatype of receiver_sync_msg.date_created column to datetime(3)</comment>

        <modifyDataType tableName="receiver_sync_msg" columnName="date_created" newDataType="DATETIME(3)" />
    </changeSet>

    <changeSet author="wluyima" id="20220926-1601">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists columnName="date_sent_by_sender" tableName="receiver_sync_msg" />
            </not>
        </preConditions>
        <comment>Add date_sent_by_sender column to receiver_sync_msg table</comment>

        <addColumn tableName="receiver_sync_msg">
            <column name="date_sent_by_sender" type="DATETIME" />
        </addColumn>
    </changeSet>

    <changeSet author="wluyima" id="20221101-0731">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists columnName="operation" tableName="receiver_sync_msg" />
            </not>
        </preConditions>
        <comment>Add operation column to receiver_sync_msg table</comment>

        <addColumn tableName="receiver_sync_msg">
            <column name="operation" type="VARCHAR(1)" />
        </addColumn>
    </changeSet>

    <changeSet author="wluyima" id="20220926-1602">
        <preConditions onFail="MARK_RAN">
            <not>
                <sqlCheck expectedResult="0">
                    SELECT COUNT(*) FROM receiver_sync_msg
                </sqlCheck>
            </not>
        </preConditions>
        <comment>Setting date_sent_by_sender and operation for existing sync messages</comment>

        <customChange class="org.openmrs.eip.app.management.receiver.SetDateSentAndOperationChangeSet">
            <param name="tableName" value="receiver_sync_msg" />
        </customChange>
    </changeSet>

    <changeSet author="wluyima" id="20220926-1603">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="date_sent_by_sender" tableName="receiver_sync_msg" />
        </preConditions>
        <comment>Adding not null constraint to receiver_sync_msg.date_sent_by_sender</comment>

        <addNotNullConstraint tableName="receiver_sync_msg" columnName="date_sent_by_sender" columnDataType="DATETIME" />
    </changeSet>

    <changeSet author="wluyima" id="20221101-0732">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="operation" tableName="receiver_sync_msg" />
        </preConditions>
        <comment>Adding not null constraint to receiver_sync_msg.operation</comment>

        <addNotNullConstraint tableName="receiver_sync_msg" columnName="operation" columnDataType="VARCHAR(1)" />
    </changeSet>

    <changeSet author="wluyima" id="20220928-1201">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="receiver_sync_archive"/>
            </not>
        </preConditions>
        <comment>Adding receiver_sync_archive table</comment>

        <createTable tableName="receiver_sync_archive">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="model_class_name" type="VARCHAR(255)">
                <constraints nullable="false" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" />
            </column>
            <column name="entity_payload" type="TEXT">
                <constraints nullable="false" />
            </column>
            <column name="site_id" type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column name="operation" type="VARCHAR(1)">
                <constraints nullable="false"/>
            </column>
            <column name="is_snapshot" type="BOOLEAN">
                <constraints nullable="false" />
            </column>
            <column name="message_uuid" type="VARCHAR(38)" />
            <column name="date_sent_by_sender" type="DATETIME">
                <constraints nullable="false" />
            </column>
            <column name="date_received" type="DATETIME(3)" />
            <column name="date_created" type="DATETIME">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="receiver_sync_archive_site_fk"
                                 baseTableName="receiver_sync_archive"
                                 baseColumnNames="site_id"
                                 referencedTableName="site_info"
                                 referencedColumnNames="id" />
    </changeSet>

    <changeSet author="wluyima" id="20220928-1203">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="status" tableName="receiver_sync_request" />
        </preConditions>
        <comment>Adding not null constraint to receiver_sync_request.status</comment>

        <addNotNullConstraint tableName="receiver_sync_request" columnName="status" columnDataType="VARCHAR(50)" />
    </changeSet>

    <changeSet author="wluyima" id="20220930-1201">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists columnName="date_sent_by_sender" tableName="receiver_retry_queue" />
            </not>
        </preConditions>
        <comment>Add date_sent_by_sender column to receiver_retry_queue table</comment>

        <addColumn tableName="receiver_retry_queue">
            <column name="date_sent_by_sender" type="DATETIME" />
        </addColumn>
    </changeSet>

    <changeSet author="wluyima" id="20221101-0733">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists columnName="operation" tableName="receiver_retry_queue" />
            </not>
        </preConditions>
        <comment>Add operation column to receiver_retry_queue table</comment>

        <addColumn tableName="receiver_retry_queue">
            <column name="operation" type="VARCHAR(1)" />
        </addColumn>
    </changeSet>

    <changeSet author="wluyima" id="20220930-1203">
        <preConditions onFail="MARK_RAN">
            <not>
                <sqlCheck expectedResult="0">
                    SELECT COUNT(*) FROM receiver_retry_queue
                </sqlCheck>
            </not>
        </preConditions>
        <comment>Setting date_sent_by_sender and operation for existing messages in error queue</comment>

        <customChange class="org.openmrs.eip.app.management.receiver.SetDateSentAndOperationChangeSet">
            <param name="tableName" value="receiver_retry_queue" />
        </customChange>
    </changeSet>

    <changeSet author="wluyima" id="20220930-1205">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="date_sent_by_sender" tableName="receiver_retry_queue" />
        </preConditions>
        <comment>Adding not null constraint to receiver_retry_queue.date_sent_by_sender</comment>

        <addNotNullConstraint tableName="receiver_retry_queue" columnName="date_sent_by_sender" columnDataType="DATETIME" />
    </changeSet>

    <changeSet author="wluyima" id="20221101-0734">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="operation" tableName="receiver_retry_queue" />
        </preConditions>
        <comment>Adding not null constraint to receiver_retry_queue.operation</comment>

        <addNotNullConstraint tableName="receiver_retry_queue" columnName="operation" columnDataType="VARCHAR(1)" />
    </changeSet>

    <changeSet author="wluyima" id="20220930-1202">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists columnName="date_sent_by_sender" tableName="receiver_conflict_queue" />
            </not>
        </preConditions>
        <comment>Add date_sent_by_sender column to receiver_conflict_queue table</comment>

        <addColumn tableName="receiver_conflict_queue">
            <column name="date_sent_by_sender" type="DATETIME" />
        </addColumn>
    </changeSet>

    <changeSet author="wluyima" id="20221101-0735">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists columnName="operation" tableName="receiver_conflict_queue" />
            </not>
        </preConditions>
        <comment>Add operation column to receiver_conflict_queue table</comment>

        <addColumn tableName="receiver_conflict_queue">
            <column name="operation" type="VARCHAR(1)" />
        </addColumn>
    </changeSet>

    <changeSet author="wluyima" id="20220930-1204">
        <preConditions onFail="MARK_RAN">
            <not>
                <sqlCheck expectedResult="0">
                    SELECT COUNT(*) FROM receiver_conflict_queue
                </sqlCheck>
            </not>
        </preConditions>
        <comment>Setting date_sent_by_sender and operation for existing messages in the conflict queue</comment>

        <customChange class="org.openmrs.eip.app.management.receiver.SetDateSentAndOperationChangeSet">
            <param name="tableName" value="receiver_conflict_queue" />
        </customChange>
    </changeSet>

    <changeSet author="wluyima" id="20220930-1206">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="date_sent_by_sender" tableName="receiver_conflict_queue" />
        </preConditions>
        <comment>Adding not null constraint to receiver_conflict_queue.date_sent_by_sender</comment>

        <addNotNullConstraint tableName="receiver_conflict_queue" columnName="date_sent_by_sender" columnDataType="DATETIME" />
    </changeSet>

    <changeSet author="wluyima" id="20221101-0736">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="operation" tableName="receiver_conflict_queue" />
        </preConditions>
        <comment>Adding not null constraint to receiver_conflict_queue.operation</comment>

        <addNotNullConstraint tableName="receiver_conflict_queue" columnName="operation" columnDataType="VARCHAR(1)" />
    </changeSet>

    <changeSet author="wluyima" id="20221005-1101">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists columnName="message_uuid" tableName="receiver_retry_queue" />
            </not>
        </preConditions>
        <comment>Add message_uuid column to receiver_retry_queue table</comment>

        <addColumn tableName="receiver_retry_queue">
            <column name="message_uuid" type="VARCHAR(38)" />
        </addColumn>
    </changeSet>

    <changeSet author="wluyima" id="20221005-1102">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists columnName="message_uuid" tableName="receiver_conflict_queue" />
            </not>
        </preConditions>
        <comment>Add message_uuid column to receiver_conflict_queue table</comment>

        <addColumn tableName="receiver_conflict_queue">
            <column name="message_uuid" type="VARCHAR(38)" />
        </addColumn>
    </changeSet>

    <changeSet author="wluyima" id="20221005-1103">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists columnName="is_snapshot" tableName="receiver_retry_queue" />
            </not>
        </preConditions>
        <comment>Add is_snapshot column to receiver_retry_queue table</comment>

        <addColumn tableName="receiver_retry_queue">
            <column name="is_snapshot" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet author="wluyima" id="20221005-1104">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists columnName="is_snapshot" tableName="receiver_conflict_queue" />
            </not>
        </preConditions>
        <comment>Add is_snapshot column to receiver_conflict_queue table</comment>

        <addColumn tableName="receiver_conflict_queue">
            <column name="is_snapshot" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet author="wluyima" id="20221007-1501">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists columnName="date_received" tableName="receiver_retry_queue" />
            </not>
        </preConditions>
        <comment>Add date_received column to receiver_retry_queue table</comment>

        <addColumn tableName="receiver_retry_queue">
            <column name="date_received" type="DATETIME(3)" />
        </addColumn>
    </changeSet>

    <changeSet author="wluyima" id="20221007-1203">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists columnName="date_received" tableName="receiver_conflict_queue" />
            </not>
        </preConditions>
        <comment>Add date_received column to receiver_conflict_queue table</comment>

        <addColumn tableName="receiver_conflict_queue">
            <column name="date_received" type="DATETIME(3)" />
        </addColumn>
    </changeSet>

    <changeSet author="wluyima" id="20230215-1000">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="receiver_synced_msg" />
            </not>
        </preConditions>
        <comment>Adding receiver_synced_msg table</comment>

        <createTable tableName="receiver_synced_msg">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="model_class_name" type="VARCHAR(255)">
                <constraints nullable="false" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" />
            </column>
            <column name="entity_payload" type="TEXT">
                <constraints nullable="false" />
            </column>
            <column name="site_id" type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column name="operation" type="VARCHAR(1)">
                <constraints nullable="false"/>
            </column>
            <column name="is_snapshot" type="BOOLEAN">
                <constraints nullable="false" />
            </column>
            <column name="message_uuid" type="VARCHAR(38)" />
            <column name="date_sent_by_sender" type="DATETIME">
                <constraints nullable="false" />
            </column>
            <column name="date_received" type="DATETIME(3)" />
            <column name="sync_outcome" type="VARCHAR(50)">
                <constraints nullable="false" />
            </column>
            <column name="response_sent" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false" />
            </column>
            <column name="is_cached" type="BOOLEAN">
                <constraints nullable="false" />
            </column>
            <column name="evicted_from_cache" type="BOOLEAN">
                <constraints nullable="false" />
            </column>
            <column name="is_indexed" type="BOOLEAN">
                <constraints nullable="false" />
            </column>
            <column name="search_index_updated" type="BOOLEAN">
                <constraints nullable="false" />
            </column>
            <column name="date_created" type="DATETIME(3)">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="receiver_synced_msg_site_fk"
                                 baseTableName="receiver_synced_msg"
                                 baseColumnNames="site_id"
                                 referencedTableName="site_info"
                                 referencedColumnNames="id" />
    </changeSet>

    <changeSet author="wluyima" id="20230330-1145">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="receiver_pruned_item"/>
            </not>
        </preConditions>
        <comment>Adding receiver_pruned_item table</comment>

        <createTable tableName="receiver_pruned_item">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="model_class_name" type="VARCHAR(255)">
                <constraints nullable="false" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" />
            </column>
            <column name="entity_payload" type="TEXT">
                <constraints nullable="false" />
            </column>
            <column name="site_id" type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column name="operation" type="VARCHAR(1)">
                <constraints nullable="false"/>
            </column>
            <column name="is_snapshot" type="BOOLEAN">
                <constraints nullable="false" />
            </column>
            <column name="message_uuid" type="VARCHAR(38)" />
            <column name="date_sent_by_sender" type="DATETIME">
                <constraints nullable="false" />
            </column>
            <column name="date_received" type="DATETIME(3)" />
            <column name="date_created" type="DATETIME">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="receiver_pruned_item_site_fk"
                                 baseTableName="receiver_pruned_item"
                                 baseColumnNames="site_id"
                                 referencedTableName="site_info"
                                 referencedColumnNames="id" />
    </changeSet>

    <changeSet author="wluyima" id="20230523-1001">
        <preConditions onFail="MARK_RAN">
            <not>
                <sqlCheck expectedResult="0">
                    SELECT COUNT(*) FROM receiver_synced_msg WHERE date_received IS NULL
                </sqlCheck>
            </not>
        </preConditions>
        <comment>Setting receiver_synced_msg.date_received where it is null</comment>

        <update tableName="receiver_synced_msg">
            <column name="date_received" valueComputed="date_created" />
            <where>date_received IS NULL</where>
        </update>
    </changeSet>

    <changeSet author="wluyima" id="20230523-1002">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="date_received" tableName="receiver_synced_msg" />
        </preConditions>
        <comment>Adding not null constraint to receiver_synced_msg.date_received</comment>

        <addNotNullConstraint tableName="receiver_synced_msg" columnName="date_received" columnDataType="DATETIME(3)" />
    </changeSet>

    <changeSet author="wluyima" id="20230523-1003">
        <preConditions onFail="MARK_RAN">
            <not>
                <sqlCheck expectedResult="0">
                    SELECT COUNT(*) FROM receiver_retry_queue WHERE date_received IS NULL
                </sqlCheck>
            </not>
        </preConditions>
        <comment>Setting receiver_retry_queue.date_received where it is null</comment>

        <update tableName="receiver_retry_queue">
            <column name="date_received" valueComputed="date_created" />
            <where>date_received IS NULL</where>
        </update>
    </changeSet>

    <changeSet author="wluyima" id="20230523-1004">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="date_received" tableName="receiver_retry_queue" />
        </preConditions>
        <comment>Adding not null constraint to receiver_retry_queue.date_received</comment>

        <addNotNullConstraint tableName="receiver_retry_queue" columnName="date_received" columnDataType="DATETIME(3)" />
    </changeSet>

    <changeSet author="wluyima" id="20230523-1005">
        <preConditions onFail="MARK_RAN">
            <not>
                <sqlCheck expectedResult="0">
                    SELECT COUNT(*) FROM receiver_conflict_queue WHERE date_received IS NULL
                </sqlCheck>
            </not>
        </preConditions>
        <comment>Setting receiver_conflict_queue.date_received where it is null</comment>

        <update tableName="receiver_conflict_queue">
            <column name="date_received" valueComputed="date_created" />
            <where>date_received IS NULL</where>
        </update>
    </changeSet>

    <changeSet author="wluyima" id="20230523-1006">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="date_received" tableName="receiver_conflict_queue" />
        </preConditions>
        <comment>Adding not null constraint to receiver_conflict_queue.date_received</comment>

        <addNotNullConstraint tableName="receiver_conflict_queue" columnName="date_received" columnDataType="DATETIME(3)" />
    </changeSet>

    <changeSet author="wluyima" id="20230526-1001">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="is_resolved" tableName="receiver_conflict_queue" />
        </preConditions>
        <comment>Deleting resolved conflicts</comment>

        <delete tableName="receiver_conflict_queue">
            <where>is_resolved = true</where>
        </delete>
    </changeSet>

    <changeSet author="wluyima" id="20230526-1002">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="is_resolved" tableName="receiver_conflict_queue" />
        </preConditions>
        <comment>Drop receiver_conflict_queue.is_resolved column</comment>

        <dropColumn tableName="receiver_conflict_queue" columnName="is_resolved" />
    </changeSet>

    <changeSet author="wluyima" id="20231208-1530">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="clinicalsummary_usage_report_hash" />
            </not>
        </preConditions>
        <comment>Adding clinicalsummary_usage_report_hash table</comment>

        <createTable tableName="clinicalsummary_usage_report_hash">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="hash" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="DATETIME(3)">
                <constraints nullable="false" />
            </column>
            <column name="date_changed" type="DATETIME(3)" />
        </createTable>
    </changeSet>

</databaseChangeLog>
